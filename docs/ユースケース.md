# 資料保存アプリ - ユースケース仕様書

**最終更新日**: 2025-10-07

> **重要**: 2025-10-06にドメインモデルを刷新しました（SQLite + Entity Framework Core採用）。
> 本ドキュメントは新ドメインモデルに基づいて更新されています。
>
> **主な変更点**:
> - `DocumentMeta` → `Document`
> - `PanelNode + ItemState` → `CheckItem`（統合）
> - `DocumentGuid` → CheckItemDocument`テーブルで管理
> - GUID識別 → 階層パス識別
> - 絶対パス → 相対パス
>
> 詳細は[ドメインモデル定義書.md](./ドメインモデル定義書.md)を参照してください。

> **実装状況について（2025-10-07更新）**:
> 現在は基盤部分（データベース、チェック項目階層表示、UI設定管理）が実装済みです。
> 資料登録・閲覧・検索などの資料管理UIは未実装です。詳細は「ユースケース一覧」を参照してください。

---

## 目次

1. [システム概要](#システム概要)
2. [ユースケース一覧](#ユースケース一覧)
3. [詳細ユースケース](#詳細ユースケース)
   - [資料管理系](#資料管理系)
   - [チェックリスト管理系](#チェックリスト管理系)
   - [データ管理系](#データ管理系)
4. [ユースケース図](#ユースケース図)
5. [非機能要件](#非機能要件)

---

## システム概要

### アプリケーション名
**資料保存アプリ (Document Manager Application)**

### 目的
技術資料とチェックリストを統合管理し、資料とチェック項目を紐づけて進捗を管理するシステム

### 主要アクター
- **エンドユーザー**: 資料管理者、チェック作業者
- **システム**: 自動処理を実行

### 対象ユーザー
- 技術文書を管理する担当者
- チェックリストベースで作業を進める担当者
- 資料と作業進捗を一元管理したい組織

---

## ユースケース一覧

### 資料管理系
| ID | ユースケース名 | 優先度 | 実装状況 |
|----|--------------|--------|---------|
| UC-001 | 資料を登録する | 高 | 🚧 未実装 |
| UC-002 | 資料一覧を閲覧する | 高 | 🔧 部分実装（DB・リポジトリのみ） |
| UC-003 | 資料を開く | 高 | 🚧 未実装 |
| UC-004 | 資料をフィルタする | 中 | 🚧 未実装 |
| UC-005 | 資料を検索する | 中 | 🚧 未実装 |

### チェックリスト管理系
| ID | ユースケース名 | 優先度 | 実装状況 |
|----|--------------|--------|---------|
| UC-010 | チェックリスト構造を定義する | 高 | ✅ 実装済み（JSONから階層読込） |
| UC-011 | チェック項目の状態を更新する | 高 | ✅ 実装済み（UI表示・DB保存） |
| UC-012 | チェック項目に資料を紐づける | 高 | 🔧 部分実装（DB構造のみ） |
| UC-013 | チェック項目のキャプチャを取得する | 中 | 🚧 未実装 |
| UC-014 | チェック項目を追加する | 中 | 🚧 未実装 |

### データ管理系
| ID | ユースケース名 | 優先度 | 実装状況 |
|----|--------------|--------|---------|
| UC-020 | データを保存する | 高 | ✅ 実装済み（EF Core + SQLite） |
| UC-021 | データを復元する | 高 | ✅ 実装済み（マイグレーション・シード） |
| UC-022 | 資料の有効性を検証する | 中 | 🚧 未実装 |

---

## 詳細ユースケース

## 資料管理系

### UC-001: 資料を登録する

**概要**: システムに新しい技術資料（PDFファイルなど）を登録する

**アクター**: エンドユーザー

**事前条件**:
- 資料ファイルが存在する
- ReferForm（参照フォーム）が表示されている

**トリガー**:
- ユーザーが資料ファイルをドラッグ&ドロップ
- ユーザーがファイル選択ダイアログから資料を選択

**基本フロー**:
1. ユーザーが資料ファイルをReferFormにドラッグ&ドロップ、またはファイル選択ダイアログから選択
2. システムがファイルのメタデータを生成:
   - `FileName`: ファイル名
   - `RelativePath`: プロジェクトルートからの相対パス
   - `FileType`: 拡張子（例: ".pdf"）
3. システムが`Document`エンティティを作成
4. システムが`DbContext.Documents.Add()`でデータベースに追加
5. システムが`SaveChangesAsync()`で保存
6. システムがListViewに資料を表示（ファイルアイコン、ファイル名、パス）

**代替フロー**:
- **1a. 同じファイルが既に登録されている場合**:
  1. システムが重複チェックを実行（`RelativePath`のUNIQUE制約）
  2. 重複が検出された場合、データベース例外をキャッチ
  3. メッセージを表示し、登録をスキップ

- **2a. ファイルが存在しない場合**:
  1. システムがエラーメッセージを表示
  2. 登録をキャンセル

**事後条件**:
- 資料が`workspace.db`の`Documents`テーブルに保存される
- 資料がListViewに表示される

**関連クラス**:
- `Document`（エンティティ）
- `DocumentManagerContext`（DbContext）
- `ReferForm`（UI）

**画面**:
```
┌─────────────────────────────────────┐
│ ReferForm - 資料一覧                │
├─────────────────────────────────────┤
│ [ファイル追加] [検索: ________]     │
├─────────────────────────────────────┤
│ 📄 設計書_rev1.pdf                  │
│    C:\Documents\設計書_rev1.pdf     │
│ 📄 仕様書_final.docx                │
│    C:\Documents\仕様書_final.docx   │
│ 📄 手順書.xlsx                      │
│    C:\Documents\手順書.xlsx         │
└─────────────────────────────────────┘
```

---

### UC-002: 資料一覧を閲覧する

**概要**: 登録された資料の一覧を表示する

**アクター**: エンドユーザー

**事前条件**:
- ReferFormが表示されている

**基本フロー**:
1. システムが`DbContext.Documents`から資料一覧を取得
   ```csharp
   var documents = await _context.Documents
       .OrderByDescending(d => d.AddedAt)
       .ToListAsync();
   ```
2. システムがListViewに資料を表示:
   - ファイルアイコン（拡張子に応じた）
   - ファイル名
   - 相対パス
3. ユーザーが一覧をスクロール・閲覧

**事後条件**:
- 資料一覧が表示される

**関連クラス**:
- `DocumentManagerContext`（DbContext）
- `ReferFormViewModel`（ViewModel）

---

### UC-003: 資料を開く

**概要**: 選択した資料ファイルを外部アプリケーションで開く

**アクター**: エンドユーザー

**事前条件**:
- 資料が選択されている

**トリガー**:
- ユーザーが資料をダブルクリック

**基本フロー**:
1. ユーザーがListViewで資料をダブルクリック
2. システムが`Document.RelativePath`から相対パスを取得
3. システムが絶対パスを構築:
   ```csharp
   var absolutePath = Path.Combine(projectRoot, document.RelativePath);
   ```
4. システムがファイルの存在を確認（`File.Exists()`）
5. システムが`Process.Start()`でデフォルトアプリケーションを起動
6. 外部アプリケーションでファイルが開かれる

**代替フロー**:
- **4a. ファイルが存在しない場合**:
  1. システムがエラーメッセージを表示:
     `"ファイルが見つかりません: {RelativePath}"`
  2. ユーザーに削除または再配置を促す

- **5a. ファイルを開けない場合**:
  1. システムがエラーメッセージを表示:
     `"ファイルを開けませんでした"`
  2. 処理を中断

**事後条件**:
- 資料ファイルが外部アプリケーションで開かれる

**関連クラス**:
- `Document`（エンティティ）
- `DocumentFileHandler`（ファイル操作サービス）
- `ReferForm`（UI）

**実装コード例**:
```csharp
// ドメインメソッド
public void Open(string projectRoot)
{
    var absolutePath = GetAbsolutePath(projectRoot);
    if (Exists(projectRoot))
    {
        Process.Start(new ProcessStartInfo(absolutePath) { UseShellExecute = true });
    }
    else
    {
        throw new FileNotFoundException($"ファイルが見つかりません: {absolutePath}");
    }
}
```

---

### UC-004: 資料をフィルタする

**概要**: チェック項目に紐づいた資料のみを表示する

**アクター**: エンドユーザー

**事前条件**:
- チェックリストが表示されている
- チェック項目に資料が紐づいている

**トリガー**:
- ユーザーがチェック項目を選択

**基本フロー**:
1. ユーザーがRegisterForm（登録フォーム）でチェック項目を選択
2. システムが選択された`ItemState`から`DocumentGuid`を取得
3. システムが`DocumentEventBinder`を通じてフィルタイベントを発行
4. `ListViewVM`がイベントを受信
5. `ListViewVM`が`DocumentGuid`に一致する資料のみをフィルタ
6. ReferFormのListViewが更新され、フィルタされた資料のみが表示される

**代替フロー**:
- **2a. 紐づいた資料がない場合**:
  1. 空の一覧を表示
  2. メッセージ表示: `"この項目に紐づいた資料はありません"`

**事後条件**:
- フィルタされた資料一覧が表示される
- 他の資料は非表示

**関連クラス**:
- `DocumentEventBinder`（イベント伝播）
- `ListViewVM`（フィルタロジック）
- `ReferFormVM`

**シーケンス**:
```
ユーザー → RegisterForm → ItemState → DocumentEventBinder → ListViewVM → ReferForm
                (選択)      (Guid取得)     (Publish)        (Filter)    (更新)
```

---

### UC-005: 資料を検索する

**概要**: ファイル名で資料を検索する

**アクター**: エンドユーザー

**事前条件**:
- ReferFormが表示されている

**トリガー**:
- ユーザーが検索ボックスにキーワードを入力

**基本フロー**:
1. ユーザーが検索ボックスにキーワードを入力（例: "設計書"）
2. システムが入力をリアルタイムで監視（TextChangedイベント）
3. システムが`DocumentMetaCollection`内の全資料に対して部分一致検索:
   ```csharp
   doc.FileName.Contains(keyword, StringComparison.OrdinalIgnoreCase)
   ```
4. マッチした資料のみをListViewに表示
5. ユーザーが検索結果を閲覧

**代替フロー**:
- **3a. マッチする資料がない場合**:
  1. 空の一覧を表示
  2. メッセージ表示: `"検索結果: 0件"`

- **1b. 検索ボックスが空の場合**:
  1. すべての資料を表示（フィルタ解除）

**事後条件**:
- 検索結果が表示される

**関連クラス**:
- `ListViewVM`（検索ロジック）
- `ReferForm`（UI）

---

## チェックリスト管理系

### UC-010: チェックリスト構造を定義する

**概要**: ツリー構造のチェックリストを定義する

**アクター**: エンドユーザー（管理者）

**事前条件**:
- DefinitionEditorが利用可能

**基本フロー**:
1. ユーザーがDefinitionEditorを起動
2. ユーザーがツリー構造でカテゴリとチェック項目を定義:
   ```
   ルート
   ├── 設計図面
   │   ├── 平面図
   │   ├── 断面図
   │   └── 詳細図
   ├── 計算書
   │   ├── 構造計算書
   │   └── 設備計算書
   └── その他
   ```
3. システムが各葉ノード（チェック対象項目）に一意のGUIDを自動割り当て（`PanelNode.AssignGuids()`）
4. ユーザーが「保存」ボタンをクリック
5. システムが`PanelNode`構造をXMLファイル（`CheckPanelNode.xml`）に保存

**事後条件**:
- チェックリスト構造が定義される
- `CheckPanelNode.xml`に保存される
- 次回起動時にこの構造が読み込まれる

**関連クラス**:
- `PanelNode`（ツリー構造）
- `CheckPanelNodeRepository`（永続化）
- `DefinitionEditor`（UI）

**データ例**:
```xml
<PanelNode>
  <Label>ルート</Label>
  <Children>
    <PanelNode>
      <Label>設計図面</Label>
      <Children>
        <PanelNode>
          <Label>平面図</Label>
          <Guid>a1b2c3d4-...</Guid>
        </PanelNode>
      </Children>
    </PanelNode>
  </Children>
</PanelNode>
```

---

### UC-011: チェック項目の状態を更新する

**概要**: チェック項目の状態（未指定/現行/改訂/キャンセル）を変更する

**アクター**: エンドユーザー

**事前条件**:
- RegisterForm（登録フォーム）が表示されている

**トリガー**:
- ユーザーがチェックボックスをクリック

**基本フロー**:
1. ユーザーがチェックボックスをクリック
2. システムが現在の`ItemState.Status`を取得
3. システムが次の状態に遷移:
   ```
   Unspecified → Current → Revised → Cancelled → Unspecified
   ```
4. システムがチェックボックスの背景色を変更:
   - `Unspecified`: グレー（未指定）
   - `Current`: 緑（現行）
   - `Revised`: 黄色（改訂）
   - `Cancelled`: 赤（キャンセル）
5. システムが`ItemState.Status`を更新
6. システムがデータを自動保存（`Status.xml`）

**状態遷移図**:
```
┌─────────────┐
│ Unspecified │ (グレー)
│  未指定     │
└─────────────┘
      ↓ クリック
┌─────────────┐
│   Current   │ (緑)
│   現行      │
└─────────────┘
      ↓ クリック
┌─────────────┐
│   Revised   │ (黄)
│   改訂      │
└─────────────┘
      ↓ クリック
┌─────────────┐
│  Cancelled  │ (赤)
│ キャンセル  │
└─────────────┘
      ↓ クリック
     (戻る)
```

**事後条件**:
- `ItemState.Status`が更新される
- チェックボックスの色が変化
- `Status.xml`に保存される

**関連クラス**:
- `ItemState`（状態管理）
- `ModeAwareCheckBox`（カスタムコントロール）
- `ItemStatus`（列挙型）

---

### UC-012: チェック項目に資料を紐づける

**概要**: チェック項目と資料ファイルを関連付ける

**アクター**: エンドユーザー

**事前条件**:
- RegisterFormが表示されている
- 資料が登録されている

**トリガー**:
- ユーザーが「資料選択」ボタンをクリック

**基本フロー**:
1. ユーザーがチェック項目を選択
2. ユーザーが「資料選択」ボタンをクリック
3. システムが資料選択ダイアログ（`SelectDocumentDialog`）を表示
4. ユーザーが資料を選択（リストから選択）
5. システムが選択された資料の`Guid`を取得
6. システムが`ItemState.SetDocumentData()`を実行:
   ```csharp
   itemState.SetDocumentData(documentGuid, null, DateTime.Now);
   ```
7. システムが`ItemState.Status`を自動的に`Current`に更新
8. システムがデータを自動保存

**代替フロー**:
- **6a. 既に別の資料が紐づいている場合**:
  1. 現在の`DocumentData`を`PastDatas`リストに追加（履歴として保存）
  2. 新しい資料を設定

- **4a. ユーザーがキャンセルした場合**:
  1. 処理を中断

**事後条件**:
- `ItemState.DocumentGuid`に資料のGUIDが設定される
- `ItemState.Status`が`Current`に更新される
- `Status.xml`に保存される
- 過去の紐づけは`PastDatas`に保存される（履歴管理）

**関連クラス**:
- `ItemState`（紐づけ管理）
- `DocumentData`（紐づけデータ）
- `RegisterForm`（UI）

**データ構造**:
```csharp
ItemState {
  Guid: "123-456-789",
  Label: "平面図",
  Status: Current,
  _documentData: {
    DocumentGuid: "abc-def-ghi",
    CaptureFile: null,
    CapturedAt: 2025-10-04 10:30:00
  },
  PastDatas: [
    { DocumentGuid: "old-111", CaptureFile: "...", CapturedAt: ... },
    { DocumentGuid: "old-222", CaptureFile: "...", CapturedAt: ... }
  ]
}
```

---

### UC-013: チェック項目のキャプチャを取得する

**概要**: 外部ウィンドウの画面キャプチャを取得し、チェック項目に紐づける

**アクター**: エンドユーザー

**事前条件**:
- RegisterFormが表示されている
- 対象ウィンドウ（例: CADソフト、PDFビューア）が起動している

**トリガー**:
- ユーザーが「キャプチャ」ボタンをクリック

**基本フロー**:
1. ユーザーがチェック項目を選択
2. ユーザーが「キャプチャ」ボタンをクリック
3. システムが対象ウィンドウを検出（`IWindowHandleProvider`）
4. システムが対象ウィンドウを最大化（`WindowMaximizeManager`）
5. システムがウィンドウのスクリーンキャプチャを取得（`ICaptureService`）
6. システムがキャプチャ画像を保存:
   - ファイル名: `{ItemGuid}_{Timestamp}.png`
   - 保存先: 設定ファイルで指定されたフォルダ
7. システムが`ItemState`を更新:
   ```csharp
   itemState.SetDocumentData(documentGuid, captureFilePath, DateTime.Now);
   ```
8. システムがデータを自動保存

**代替フロー**:
- **3a. 対象ウィンドウが見つからない場合**:
  1. エラーメッセージを表示: `"対象ウィンドウが見つかりません"`
  2. 処理を中断

- **5a. キャプチャに失敗した場合**:
  1. エラーメッセージを表示: `"キャプチャに失敗しました"`
  2. 処理を中断

**事後条件**:
- キャプチャ画像が保存される
- `ItemState.CaptureFile`にファイルパスが設定される
- `ItemState.CapturedAt`に日時が設定される
- `Status.xml`に保存される

**関連クラス**:
- `ICaptureService`（ScreenCaptureLib）
- `ICapturePictureRepository`（画像保存）
- `WindowMaximizeManager`（ウィンドウ操作）
- `RegisterFormController`（コントローラー）

**シーケンス**:
```
ユーザー → RegisterForm → WindowManager → CaptureService → Repository → ItemState
  (クリック)    (開始)       (最大化)       (キャプチャ)    (保存)     (更新)
```

---

### UC-014: チェック項目を追加する

**概要**: ユーザーが動的にチェック項目を追加する

**アクター**: エンドユーザー

**事前条件**:
- RegisterFormが表示されている

**トリガー**:
- ユーザーが「チェック項目追加」ボタンをクリック

**基本フロー**:
1. ユーザーが「チェック項目追加」ボタンをクリック
2. システムが入力ダイアログを表示
3. ユーザーが新しい項目名を入力（例: "詳細図A"）
4. ユーザーが「OK」ボタンをクリック
5. システムが`PanelNode.AddNode(label)`を実行:
   - "ユーザー追加データ"グループが存在しない場合、新規作成
   - 新しいノードを"ユーザー追加データ"グループに追加
   - 新規ノードに一意のGUIDを自動割り当て
6. システムが対応する`ItemState`を生成:
   ```csharp
   new ItemState(label, newGuid, ItemStatus.Unspecified)
   ```
7. システムが`ItemStateCollection`に追加
8. システムがチェックリストUIを更新（新しいチェックボックスを追加）
9. システムがデータを自動保存（`CheckPanelNode.xml`, `Status.xml`）

**代替フロー**:
- **3a. ユーザーがキャンセルした場合**:
  1. 処理を中断

- **3b. 空の項目名が入力された場合**:
  1. エラーメッセージ表示: `"項目名を入力してください"`
  2. 再入力を促す

**事後条件**:
- 新しいチェック項目が追加される
- `CheckPanelNode.xml`に保存される
- `Status.xml`に保存される
- UIに新しいチェックボックスが表示される

**関連クラス**:
- `PanelNode`（ツリー構造更新）
- `ItemState`（新規状態生成）
- `RegisterFormController`（UI更新）

**ツリー構造例**:
```
ルート
├── 設計図面
│   ├── 平面図
│   └── 断面図
└── ユーザー追加データ  ← 自動作成
    ├── 詳細図A        ← 追加
    └── 詳細図B        ← 追加
```

---

## データ管理系

### UC-020: データを保存する

**概要**: 現在の状態をSQLiteデータベースに永続化する

**アクター**: システム（自動）

**事前条件**:
- データが変更されている

**トリガー**:
- データ変更操作の完了時（Entity Framework Coreの`SaveChangesAsync()`）
- アプリケーション終了時

**基本フロー**:
1. ユーザーがデータ変更操作を実行（チェック状態更新、資料紐づけ等）
2. システムが`DbContext.SaveChangesAsync()`を実行
3. 保存前に自動バックアップ作成（`workspace.db` → `workspace.db.backup`）
4. トランザクション内で全変更をコミット
5. 保存完了

**代替フロー**:
- **4a. 保存に失敗した場合**:
  1. トランザクションを自動ロールバック
  2. バックアップから復元（`workspace.db.backup` → `workspace.db`）
  3. エラーメッセージを表示
  4. ユーザーにリトライを促す

**事後条件**:
- データが`workspace.db`に保存される
- バックアップファイルが作成される
- 次回起動時に復元可能

**関連クラス**:
- `DocumentManagerContext`（DbContext）
- `IUnitOfWork`（トランザクション管理）

**備考**:
- SQLiteのトランザクション（ACID特性）により原子性を保証
- 旧方式のような3ファイル同期の複雑さは不要

---

### UC-021: データを復元する

**概要**: アプリ起動時にSQLiteデータベースからデータを読み込む

**アクター**: システム（自動）

**事前条件**:
- なし（初回起動でも可）

**トリガー**:
- アプリケーション起動

**基本フロー**:
1. アプリケーション起動
2. `DocumentManagerContext`を初期化
3. データベース接続確立（`workspace.db`）
4. Entity Framework Coreがスキーマを確認
5. データをメモリに読み込み（必要に応じて遅延ロード）
6. UIを表示

**代替フロー**:
- **3a. workspace.dbが存在しない場合（初回起動）**:
  1. Entity Framework Coreが自動的に空のデータベースを作成
  2. マイグレーションを適用してテーブルを生成
  3. 初期データ（サンプルチェックリスト）を投入（オプション）
  4. 通常フローに戻る

- **3b. データベースが破損している場合**:
  1. 例外をキャッチ
  2. バックアップファイル（`workspace.db.backup`）の存在を確認
  3. バックアップから復元
  4. 通常フローに戻る
  5. バックアップがない場合、エラーメッセージを表示し、新規作成を提案

- **4a. スキーマバージョンが古い場合**:
  1. Entity Framework Coreが自動的にマイグレーションを検出
  2. 必要なマイグレーションを適用
  3. スキーマを最新に更新

**事後条件**:
- データベース接続が確立される
- データがメモリに読み込まれる
- UIが使用可能な状態になる

**関連クラス**:
- `DocumentManagerContext`（DbContext）
- `ApplicationBootstrapper`（起動処理）

**シーケンス**:
```
Program → ApplicationBootstrapper → DocumentManagerContext → EF Core → SQLite
 (Main)        (Initialize)              (Connect)           (Load)    (workspace.db)
```

**備考**:
- 旧方式の複雑な読み込み順序・GUID修復処理は不要
- Entity Framework Coreがスキーマ管理とマイグレーションを自動処理

---

### UC-022: 資料ファイルの有効性を検証する

**概要**: 登録済み資料ファイルの実在性を確認し、存在しないファイルを警告する

**アクター**: システム（自動）

**事前条件**:
- アプリケーションが起動している

**トリガー**:
- アプリケーション起動時
- 資料一覧表示時
- ユーザーが明示的に検証を実行

**基本フロー**:
1. システムがデータベースから全資料を取得
   ```csharp
   var documents = await _context.Documents.ToListAsync();
   ```
2. 各資料について物理ファイルの存在を確認
   ```csharp
   var absolutePath = Path.Combine(projectRoot, document.RelativePath);
   var exists = File.Exists(absolutePath);
   ```
3. 存在しないファイルがあれば警告を表示:
   - UI上で警告アイコンを表示
   - ログに記録: `"警告: 資料ファイルが見つかりません: {RelativePath}"`
4. 検証結果をユーザーに通知

**代替フロー**:
- **3a. ユーザーが削除を選択した場合**:
  1. 確認ダイアログを表示
  2. OKの場合、`CheckItemDocuments`から該当レコードを削除（CASCADE DELETE）
  3. `Documents`テーブルから該当レコードを削除
  4. トランザクションをコミット

- **3b. ユーザーが再配置を選択した場合**:
  1. ファイル選択ダイアログを表示
  2. 新しいファイルパスを取得
  3. `Documents.RelativePath`を更新
  4. 保存

**事後条件**:
- 存在しないファイルが識別される
- ユーザーに警告が表示される
- ユーザーの選択に応じてデータが更新される

**関連クラス**:
- `DocumentValidationService`（検証ロジック）
- `DocumentManagerContext`（データアクセス）

**備考**:
- **データベースの参照整合性は自動保証される**（外部キー制約）
- 旧方式のような`GUID修復処理`や`孤立データのクリーンアップ`は不要
- ファイルシステムとDBの同期のみを確認

---

## ユースケース図

```
┌─────────────────────────────────────────────────────────┐
│                   資料保存アプリ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐                                      │
│  │エンドユーザー│                                      │
│  └──────┬───────┘                                      │
│         │                                               │
│         │ UC-001: 資料を登録                            │
│         │ UC-002: 資料一覧を閲覧                        │
│         │ UC-003: 資料を開く                            │
│         │ UC-004: 資料をフィルタ                        │
│         │ UC-005: 資料を検索                            │
│         │                                               │
│         │ UC-010: チェックリスト構造を定義              │
│         │ UC-011: チェック項目の状態を更新              │
│         │ UC-012: チェック項目に資料を紐づける          │
│         │ UC-013: チェック項目のキャプチャを取得        │
│         │ UC-014: チェック項目を追加                    │
│         │                                               │
│         │                                               │
│  ┌──────▼───────┐                                      │
│  │  システム    │                                      │
│  └──────┬───────┘                                      │
│         │                                               │
│         │ UC-020: データを保存                          │
│         │ UC-021: データを復元                          │
│         │ UC-022: 資料の有効性を検証                    │
│         │                                               │
└─────────────────────────────────────────────────────────┘
```

---

## 非機能要件

### 1. パフォーマンス

| 項目 | 要件 | 測定方法 |
|------|------|---------|
| 起動時間 | 3秒以内 | アプリ起動からReferForm表示まで |
| 資料一覧表示 | 100件で1秒以内 | DocumentMetaCollectionの読み込みとListView描画 |
| データ保存 | 3秒以内 | FormClosing時のXML書き込み完了まで |
| 検索レスポンス | 0.5秒以内 | キーワード入力からListView更新まで |

### 2. データ永続化

| 項目 | 要件 |
|------|------|
| フォーマット | XML（UTF-8エンコーディング） |
| 保存タイミング | フォーム閉鎖時、明示的保存操作時 |
| バックアップ | 保存前に既存ファイルを`.backup`として保存 |
| データ整合性 | GUID参照の検証、無効なデータのクリーンアップ |

### 3. UI/UX

| 項目 | 要件 |
|------|------|
| UIフレームワーク | Windows Forms |
| 対応OS | Windows 10/11 |
| 解像度 | 1920x1080以上推奨 |
| 操作方法 | マウス、キーボード、ドラッグ&ドロップ |
| 多言語対応 | 現状は日本語のみ（将来的に英語対応予定） |

### 4. セキュリティ

| 項目 | 要件 |
|------|------|
| ファイルアクセス | ローカルファイルシステムのみ |
| 認証 | 不要（ローカルアプリケーション） |
| データ暗号化 | 現状なし（将来的に機密資料用に検討） |

### 5. 拡張性

| 項目 | 要件 |
|------|------|
| プラグイン対応 | 現状なし |
| API公開 | 現状なし（NuGetライブラリとしての利用は可能） |
| カスタマイズ | 設定ファイル（`appsettings.json`）での調整 |

### 6. 保守性

| 項目 | 要件 |
|------|------|
| ログ機能 | コンソール出力（将来的にファイル出力） |
| エラーハンドリング | グローバル例外ハンドラ、ユーザーフレンドリーなメッセージ |
| ドキュメント | コード内XMLドキュメント、設計書、ユースケース |

---

## 付録

### A. 画面遷移図

```
┌─────────────┐
│   起動      │
└──────┬──────┘
       │
       ▼
┌─────────────┐      ダブルクリック      ┌─────────────┐
│  ReferForm  │────────────────────────→│外部アプリ起動│
│ (資料一覧)  │                         │  (PDF等)    │
└──────┬──────┘                         └─────────────┘
       │
       │ チェック項目選択
       │
       ▼
┌─────────────┐
│RegisterForm │
│(チェックリスト)│
└──────┬──────┘
       │
       │ 資料選択/キャプチャ
       │
       ▼
  ItemState更新
```

### B. データモデルER図

```
┌───────────────┐          ┌───────────────┐
│ DocumentMeta  │          │  ItemState    │
├───────────────┤          ├───────────────┤
│ Guid          │◄─────────│ DocumentGuid  │
│ FileName      │   紐づけ  │ Guid          │
│ FullPath      │          │ Label         │
└───────────────┘          │ Status        │
                           │ CaptureFile   │
                           │ CapturedAt    │
                           │ PastDatas[]   │
                           └───────┬───────┘
                                   │
                                   │ 対応
                                   │
                           ┌───────▼───────┐
                           │  PanelNode    │
                           ├───────────────┤
                           │ Guid (葉のみ) │
                           │ Label         │
                           │ Children[]    │
                           └───────────────┘
```

### C. 状態遷移マトリクス

| 現在の状態 | イベント | 次の状態 | 備考 |
|-----------|---------|---------|------|
| Unspecified | チェック | Current | 初回チェック |
| Current | チェック | Revised | 改訂マーク |
| Revised | チェック | Cancelled | キャンセルマーク |
| Cancelled | チェック | Unspecified | リセット |
| Any | 資料紐づけ | Current | 自動的にCurrentに |
| Any | 資料削除 | Unspecified | 紐づけ解除 |

---

**関連ドキュメント**:
- [プログラム構成と課題.md](./プログラム構成と課題.md) - システムアーキテクチャと問題点分析

---

**改訂履歴**:
| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|-------|
| 2025-10-04 | 1.0 | 初版作成 | システム分析 |
