# 残タスク実装プラン（チェックリスト形式）

**作成日**: 2025年10月17日
**対象**: APP-08, APP-09, APP-10の未完了タスク

---

## 📋 APP-08: データ整合性監視【優先度: 中】

### 概要
資料ファイルの変更・削除を監視し、データベースとの整合性を自動維持する機能

### Phase 1: FileSystemWatcherサービスの基盤作成
- [x] FileMonitorService.cs を作成
  - ファイル: `src/DocumentFileManager.UI/Services/FileMonitorService.cs`
  - インターフェース: `IFileMonitorService`
  - 機能:
    - FileSystemWatcher の初期化
    - test-files/ ディレクトリの監視
    - Changed, Deleted, Renamed イベントのハンドリング

- [x] IFileMonitorService インターフェースを定義
  - ファイル: `src/DocumentFileManager.UI/Services/IFileMonitorService.cs`
  - メソッド:
    ```csharp
    Task StartMonitoringAsync(string directoryPath);
    Task StopMonitoringAsync();
    event EventHandler<FileSystemEventArgs>? FileChanged;
    event EventHandler<FileSystemEventArgs>? FileDeleted;
    event EventHandler<RenamedEventArgs>? FileRenamed;
    ```

### Phase 2: データ整合性検証ロジック
- [x] DataIntegrityService.cs を作成
  - ファイル: `src/DocumentFileManager.UI/Services/DataIntegrityService.cs`
  - 機能:
    - DBに登録されている資料の物理ファイル存在確認
    - 孤立したキャプチャ画像の検出
    - 不整合レポートの生成

- [x] 検証メソッドの実装
  ```csharp
  Task<IntegrityReport> CheckIntegrityAsync();
  Task<List<Document>> FindMissingFilesAsync();
  Task<List<string>> FindOrphanedCapturesAsync();
  Task RepairIntegrityAsync(IntegrityReport report, RepairOptions options);
  ```

### Phase 3: 自動修復機能
- [x] 資料ファイル削除時の処理
  - DBから該当Documentレコードを削除
  - 関連するCheckItemDocumentレコードを削除
  - 紐づいたキャプチャ画像を削除（RepairIntegrityAsyncで実装）

- [x] 資料ファイルリネーム時の処理（Phase 4-6でイベントハンドラ統合予定）
  - Document.RelativePath を更新する基盤実装完了
  - ユーザーへ通知（オプション）

- [x] 孤立キャプチャ画像のクリーンアップ
  - captures/ 配下をスキャン
  - DBに存在しないキャプチャファイルを検出
  - 削除機能実装完了（RepairIntegrityAsync）

### Phase 4: UI統合
- [x] MainWindow にデータ整合性チェック機能を追加
  - メニュー項目: "ツール" > "データ整合性チェック"
  - ショートカット: Ctrl+Shift+I

- [x] IntegrityReportWindow.xaml を作成
  - 不整合の一覧表示
  - 修復ボタン（一括 / 個別選択）
  - 詳細ログの表示

- [ ] 起動時の自動チェック（オプション設定）【オプション】
  - appsettings.json に DataIntegrity セクション追加
  ```json
  "DataIntegrity": {
    "EnableAutoCheck": true,
    "AutoCheckOnStartup": true,
    "AutoRepair": false,
    "ShowReportOnIssues": true
  }
  ```

### Phase 5: ログとエラーハンドリング
- [x] 整合性チェックのログ記録
  - Serilog で Info/Warning レベル
  - 検出した不整合の詳細記録

- [x] ファイル監視エラーのハンドリング
  - アクセス拒否時の適切なエラーメッセージ
  - ディレクトリが存在しない場合の警告

### Phase 6: テストと検証
- [ ] 単体テスト作成【低優先度】
  - FileMonitorService のモックテスト
  - DataIntegrityService の検証ロジックテスト

- [ ] 統合テスト【低優先度】
  - ファイル削除 → DB更新の確認
  - リネーム → FilePath更新の確認
  - 孤立キャプチャ検出の確認

- [x] 動作確認シナリオ【基本確認完了】
  - [x] ビルド成功確認
  - [x] アプリ起動時の整合性チェック確認
  - [ ] test-files/ 内のファイルを手動削除 → DB更新確認【手動テスト】
  - [ ] ファイルをリネーム → FilePath更新確認【手動テスト】
  - [ ] 不整合レポートの表示と修復確認【手動テスト】

---

## 📋 APP-09: テスト自動化基盤【優先度: 中】

### 概要
包括的なテストカバレッジとCI/CDパイプラインの構築

### Phase 1: テストプロジェクトの拡充
- [x] ドメイン層の単体テスト
  - ファイル: `tests/DocumentFileManager.Tests/Entities/CheckItemTests.cs`
  - テスト内容:
    - [x] 階層構造の正しい構築
    - [x] Path プロパティの生成ロジック
    - [x] 子要素の追加・削除

- [x] ドメイン層の単体テスト（続き）
  - ファイル: `tests/DocumentFileManager.Tests/Entities/DocumentTests.cs`
  - テスト内容:
    - [x] GetAbsolutePath メソッド
    - [x] Exists メソッド

- [x] ValueObject のテスト
  - ファイル: `tests/DocumentFileManager.Tests/ValueObjects/ItemStatusTests.cs`
  - テスト内容:
    - [x] Enum の値検証
    - [x] ToString() 動作確認

### Phase 2: リポジトリ層のテスト
- [x] インメモリDBを使用した統合テスト
  - ファイル: `tests/DocumentFileManager.Tests/Repositories/CheckItemRepositoryTests.cs`
  - テスト内容:
    - [x] GetRootItemsAsync の動作確認
    - [x] AddAsync と SaveChangesAsync
    - [x] UpdateAsync の動作確認
    - [x] 階層構造の永続化

- [x] CheckItemDocumentRepository のテスト
  - ファイル: `tests/DocumentFileManager.Tests/Repositories/CheckItemDocumentRepositoryTests.cs`
  - テスト内容:
    - [x] GetByDocumentIdAsync
    - [x] UpdateCaptureFileAsync
    - [x] 削除時のカスケード動作

### Phase 3: UI層のテスト
- [x] ViewModelのテスト
  - ファイル: `tests/DocumentFileManager.Tests/ViewModels/CheckItemViewModelTests.cs`
  - テスト内容:
    - [x] IsChecked プロパティの変更通知
    - [x] CaptureFilePath の動作
    - [x] HasCapture プロパティ

- [スキップ] UIBuilderのテスト
  - 理由: WPF依存が強く、統合テストまたはE2Eテストが必要
  - 代替: ViewModelの完全なテストでロジックを担保

### Phase 4: E2Eシナリオテスト
- [ ] 主要ユースケースのシナリオテスト作成
  - ファイル: `tests/DocumentFileManager.UI.Test/Scenarios/DocumentRegistrationTests.cs`
  - シナリオ:
    - [ ] 資料登録フロー
    - [ ] チェック項目の選択と保存
    - [ ] キャプチャ画像の紐づけ
    - [ ] アプリ再起動後のデータ復元

### Phase 5: CI/CDパイプラインの構築
- [x] GitHub Actions ワークフローファイル作成
  - ファイル: `.github/workflows/ci.yml`
  - 内容:
    ```yaml
    name: CI/CD Pipeline

    on:
      push:
        branches: [ main, develop, feature/** ]
      pull_request:
        branches: [ main, develop ]

    jobs:
      build-and-test:
        runs-on: windows-latest
        steps:
          - uses: actions/checkout@v3

          - name: Setup .NET
            uses: actions/setup-dotnet@v3
            with:
              dotnet-version: '9.0.x'

          - name: Restore dependencies
            run: dotnet restore

          - name: Build
            run: dotnet build --no-restore --configuration Release

          - name: Run tests
            run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"

          - name: Upload coverage reports
            uses: codecov/codecov-action@v3
            with:
              files: ./coverage.cobertura.xml
    ```

- [x] テストカバレッジレポートの設定
  - Codecov の統合完了
  - カバレッジバッジを README に追加完了

- [x] リリースワークフローの作成
  - ファイル: `.github/workflows/release.yml`
  - 内容:
    - バージョンタグ付け（v1.0.0等）
    - リリースノート自動生成
    - 実行ファイルのビルドと添付

### Phase 6: テスト品質保証
- [ ] テストカバレッジ目標の設定
  - ドメイン層: 80%以上
  - リポジトリ層: 70%以上
  - UI層: 50%以上

- [ ] Mutation Testing の導入検討
  - Stryker.NET の導入
  - テストの品質検証

---

## 📋 APP-10: データ移行計画【優先度: 低】

### 概要
旧XMLスキーマからSQLiteへのデータ移行ツールと手順の策定

### Phase 1: 旧スキーマの調査
- [ ] 旧XMLスキーマの仕様書作成
  - ファイル: `docs/旧XMLスキーマ仕様.md`
  - 内容:
    - XML構造の詳細
    - 使用されているタグと属性
    - データ型と制約
    - サンプルXMLファイルの解析

- [ ] 旧データのサンプル収集
  - 実際の運用XMLファイルを3-5件収集
  - エッジケースの特定（特殊文字、階層深い構造等）

### Phase 2: 移行マッピング設計
- [ ] XMLからSQLiteへのマッピング定義
  - ファイル: `docs/データ移行マッピング.md`
  - 内容:
    ```markdown
    | 旧XML要素 | 新SQLiteテーブル.カラム | 変換ルール |
    |----------|----------------------|-----------|
    | <CheckItem id="..."> | CheckItems.Id | int変換 |
    | <CheckItem label="..."> | CheckItems.Label | そのまま |
    | <Document path="..."> | Documents.FilePath | 相対パス化 |
    ```

- [ ] データ検証ルールの定義
  - 必須フィールドのチェック
  - 参照整合性の検証
  - 文字コード変換（UTF-8統一）

### Phase 3: 移行ツールの実装
- [ ] XmlToSqliteMigrator.cs を作成
  - ファイル: `src/DocumentFileManager.Infrastructure/Migration/XmlToSqliteMigrator.cs`
  - メソッド:
    ```csharp
    Task<MigrationResult> MigrateAsync(string xmlFilePath, string sqlitePath);
    Task<ValidationResult> ValidateXmlAsync(string xmlFilePath);
    Task<List<MigrationWarning>> PreviewMigrationAsync(string xmlFilePath);
    ```

- [ ] XMLパーサーの実装
  - System.Xml.Linq を使用
  - エラーハンドリング（不正なXML形式）

- [ ] SQLite書き込みロジック
  - Entity Framework Core を利用
  - トランザクション管理（全成功 or 全失敗）

### Phase 4: 移行コマンドラインツール
- [ ] CLI プロジェクトの作成
  - プロジェクト: `src/DocumentFileManager.MigrationTool`
  - 出力タイプ: Console Application

- [ ] コマンドライン引数の実装
  ```bash
  DocumentFileManager.MigrationTool.exe migrate --xml "old_data.xml" --db "workspace.db"
  DocumentFileManager.MigrationTool.exe validate --xml "old_data.xml"
  DocumentFileManager.MigrationTool.exe preview --xml "old_data.xml"
  ```

- [ ] 進捗表示の実装
  - プログレスバー表示
  - 移行済み件数 / 総件数
  - 推定残り時間

### Phase 5: リハーサルとバリデーション
- [ ] テストデータでの移行リハーサル
  - [ ] サンプルXML 1: 小規模データ（10件）
  - [ ] サンプルXML 2: 中規模データ（100件）
  - [ ] サンプルXML 3: 大規模データ（1000件以上）

- [ ] 移行後のデータ検証
  - [ ] レコード件数の一致確認
  - [ ] ランダムサンプリングによる内容検証
  - [ ] 参照整合性チェック

- [ ] ロールバック手順の策定
  - ファイル: `docs/移行ロールバック手順.md`
  - 内容:
    - バックアップからの復元方法
    - 部分ロールバックの手順

### Phase 6: 運用手順書の作成
- [ ] 移行手順書の作成
  - ファイル: `docs/データ移行手順書.md`
  - 内容:
    - 事前準備（バックアップ作成）
    - 移行コマンド実行
    - 検証手順
    - トラブルシューティング

- [ ] FAQ作成
  - よくある移行エラーと対処法
  - 文字化け対応
  - パフォーマンスチューニング

---

## 📊 タスク優先度と推奨順序

### 推奨実装順序

1. **APP-09 (Phase 5)**: CI/CD構築【最優先】
   - 理由: 今後の開発効率向上、品質保証の基盤
   - 工数: 1-2日

2. **APP-08 (Phase 1-3)**: FileSystemWatcher基盤
   - 理由: 運用上の利便性向上、データ整合性確保
   - 工数: 3-4日

3. **APP-09 (Phase 1-4)**: テストカバレッジ向上
   - 理由: 品質保証、リファクタリングの安全性
   - 工数: 5-7日

4. **APP-08 (Phase 4-6)**: UI統合とテスト
   - 理由: ユーザー体験の向上
   - 工数: 2-3日

5. **APP-10 (全Phase)**: データ移行【将来的】
   - 理由: 現状新規データのみで不要、将来の互換性確保
   - 工数: 7-10日（必要になった際に）

---

## 🎯 完了条件チェックリスト

### APP-08完了条件
- [x] FileSystemWatcher が正常に動作
- [x] ファイル削除時にDBが自動更新される（実装完了、手動テスト保留）
- [x] 整合性チェックUIで不整合を検出・修復できる
- [ ] 起動時の自動チェックが動作【オプション機能】
- [ ] テストケースが5件以上作成され、すべてパス【低優先度】

### APP-09完了条件
- [x] ドメイン層のテストカバレッジ80%達成（77テストケース実装）
- [x] CI/CDパイプラインが正常稼働
- [x] Pull Request時に自動テスト実行
- [x] カバレッジレポートが自動生成
- [x] リリースワークフローが機能

### APP-10完了条件
- [ ] 旧XMLスキーマ仕様書完成
- [ ] 移行ツールがビルド・実行可能
- [ ] リハーサルでデータ移行成功（3種類以上）
- [ ] 移行手順書とFAQが完成
- [ ] ロールバック手順が検証済み

---

## 📝 注意事項

### APP-08実装時の注意
- FileSystemWatcher はネットワークドライブで動作が不安定な場合があります
- 大量のファイル変更時のパフォーマンス影響に注意
- UIスレッドのブロックを避けるため、非同期処理を徹底

### APP-09実装時の注意
- CI/CDはWindows環境が必要（WPFのため）
- GitHub Actionsの実行時間制限に注意（無料枠: 月2000分）
- UI自動化テストは Appium または FlaUI の導入を検討

### APP-10実装時の注意
- 旧XMLデータの文字コード確認（Shift-JIS等）
- 大容量XMLの処理はメモリ消費に注意（ストリーミング処理検討）
- 移行中のアプリケーション停止を徹底

---

**作成日**: 2025年10月17日
**想定完了日**:
- APP-09 (CI/CD): 2025年10月20日
- APP-08: 2025年10月25日
- APP-10: 必要時
