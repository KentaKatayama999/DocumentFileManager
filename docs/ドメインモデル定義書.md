# ドメインモデル定義書

**作成日**: 2025-10-06
**対象システム**: 資料保存アプリ (Document Manager Application)

---

## 1. 概要

本ドキュメントでは、SQLite + Entity Framework Coreを採用した新しいドメインモデルを定義します。

### 旧設計からの主な変更点

| 項目 | 旧設計 | 新設計 | 理由 |
|------|--------|--------|------|
| 構造と状態の管理 | PanelNode（構造）+ ItemState（状態）を分離 | **CheckItem**に統合 | 二重管理の廃止、データ整合性向上 |
| 資料クラス | DocumentMeta | **Document** | 名前の簡潔化 |
| 識別方法 | GUIDのみ | **Path**（階層パス）+ Id | 人間可読性の向上 |
| パス管理 | 絶対パス | **相対パス** | ポータビリティの確保 |
| 紐づけ管理 | ItemState内にDocumentGuid | **CheckItemDocument**独立テーブル | 履歴管理の改善 |
| 参照整合性 | 手動チェック（RepairInvalidGuids等） | **外部キー制約**で自動保証 | 整合性保証の自動化 |

---

## 2. エンティティ定義

### 2.1 CheckItem（チェックリスト項目）

**責務**: チェックリストの項目と状態を管理（構造と状態を統合）

```csharp
namespace DocumentFileManager.Domain.Entities;

/// <summary>
/// チェックリスト項目
/// </summary>
public class CheckItem
{
    /// <summary>
    /// 内部ID（主キー）
    /// </summary>
    public int Id { get; set; }

    /// <summary>
    /// 階層パス（一意識別子）
    /// 例: "設計図面/平面図"
    /// </summary>
    [Required]
    [MaxLength(500)]
    public string Path { get; set; } = "";

    /// <summary>
    /// 表示名
    /// 例: "平面図"
    /// </summary>
    [Required]
    [MaxLength(200)]
    public string Label { get; set; } = "";

    /// <summary>
    /// チェック状態
    /// </summary>
    [Required]
    public ItemStatus Status { get; set; } = ItemStatus.Unspecified;

    /// <summary>
    /// 親項目のID（ルートの場合はnull）
    /// </summary>
    public int? ParentId { get; set; }

    /// <summary>
    /// 親項目（ナビゲーションプロパティ）
    /// </summary>
    [ForeignKey(nameof(ParentId))]
    public CheckItem? Parent { get; set; }

    /// <summary>
    /// 子項目リスト（ナビゲーションプロパティ）
    /// </summary>
    public List<CheckItem> Children { get; set; } = new();

    /// <summary>
    /// 同階層内での表示順序
    /// </summary>
    public int DisplayOrder { get; set; }

    /// <summary>
    /// 作成日時
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// 更新日時
    /// </summary>
    public DateTime UpdatedAt { get; set; }

    /// <summary>
    /// 紐づけられた資料リスト（ナビゲーションプロパティ）
    /// </summary>
    public List<CheckItemDocument> LinkedDocuments { get; set; } = new();

    // ドメインロジック

    /// <summary>
    /// 子項目かどうか
    /// </summary>
    public bool IsLeaf => Children.Count == 0;

    /// <summary>
    /// ルート項目かどうか
    /// </summary>
    public bool IsRoot => ParentId == null;

    /// <summary>
    /// 最新の紐づけを取得
    /// </summary>
    public CheckItemDocument? GetLatestLink()
    {
        return LinkedDocuments
            .OrderByDescending(ld => ld.LinkedAt)
            .FirstOrDefault();
    }

    /// <summary>
    /// 状態を次に進める（循環）
    /// Unspecified → Current → Revised → Cancelled → Unspecified
    /// </summary>
    public void AdvanceStatus()
    {
        Status = Status switch
        {
            ItemStatus.Unspecified => ItemStatus.Current,
            ItemStatus.Current => ItemStatus.Revised,
            ItemStatus.Revised => ItemStatus.Cancelled,
            ItemStatus.Cancelled => ItemStatus.Unspecified,
            _ => ItemStatus.Unspecified
        };
        UpdatedAt = DateTime.UtcNow;
    }
}
```

**制約**:
- `Path`は一意（UNIQUE制約）
- `ParentId`は自己参照外部キー（階層構造を表現）

---

### 2.2 Document（資料）

**責務**: 資料ファイルのメタデータを管理

```csharp
namespace DocumentFileManager.Domain.Entities;

/// <summary>
/// 資料ファイル
/// </summary>
public class Document
{
    /// <summary>
    /// 内部ID（主キー）
    /// </summary>
    public int Id { get; set; }

    /// <summary>
    /// ファイル名
    /// 例: "設計書_rev1.pdf"
    /// </summary>
    [Required]
    [MaxLength(255)]
    public string FileName { get; set; } = "";

    /// <summary>
    /// 相対パス（プロジェクトルート基準）
    /// 例: "documents/設計書_rev1.pdf"
    /// </summary>
    [Required]
    [MaxLength(500)]
    public string RelativePath { get; set; } = "";

    /// <summary>
    /// ファイル種別（拡張子）
    /// 例: ".pdf", ".docx", ".xlsx"
    /// </summary>
    [Required]
    [MaxLength(50)]
    public string FileType { get; set; } = "";

    /// <summary>
    /// 登録日時
    /// </summary>
    public DateTime AddedAt { get; set; }

    /// <summary>
    /// この資料に紐づくチェック項目リスト（ナビゲーションプロパティ）
    /// </summary>
    public List<CheckItemDocument> LinkedCheckItems { get; set; } = new();

    // ドメインロジック

    /// <summary>
    /// 絶対パスを取得
    /// </summary>
    public string GetAbsolutePath(string projectRoot)
    {
        return Path.Combine(projectRoot, RelativePath);
    }

    /// <summary>
    /// ファイルが存在するか確認
    /// </summary>
    public bool Exists(string projectRoot)
    {
        return File.Exists(GetAbsolutePath(projectRoot));
    }
}
```

**制約**:
- `RelativePath`は一意（UNIQUE制約）
- ファイルの重複登録を防止

---

### 2.3 CheckItemDocument（紐づけ）

**責務**: チェック項目と資料の関連付けを管理（履歴として保持）

```csharp
namespace DocumentFileManager.Domain.Entities;

/// <summary>
/// チェック項目と資料の紐づけ（履歴対応）
/// </summary>
public class CheckItemDocument
{
    /// <summary>
    /// 内部ID（主キー）
    /// </summary>
    public int Id { get; set; }

    /// <summary>
    /// チェック項目ID
    /// </summary>
    public int CheckItemId { get; set; }

    /// <summary>
    /// チェック項目（ナビゲーションプロパティ）
    /// </summary>
    [ForeignKey(nameof(CheckItemId))]
    public CheckItem CheckItem { get; set; } = null!;

    /// <summary>
    /// 資料ID
    /// </summary>
    public int DocumentId { get; set; }

    /// <summary>
    /// 資料（ナビゲーションプロパティ）
    /// </summary>
    [ForeignKey(nameof(DocumentId))]
    public Document Document { get; set; } = null!;

    /// <summary>
    /// 紐づけ日時
    /// </summary>
    public DateTime LinkedAt { get; set; }

    /// <summary>
    /// キャプチャファイルパス（相対パス、オプション）
    /// 例: "captures/平面図_20251004.png"
    /// </summary>
    [MaxLength(500)]
    public string? CaptureFile { get; set; }

    /// <summary>
    /// キャプチャ取得日時
    /// </summary>
    public DateTime? CapturedAt { get; set; }

    // ドメインロジック

    /// <summary>
    /// キャプチャが存在するか
    /// </summary>
    public bool HasCapture => !string.IsNullOrEmpty(CaptureFile);

    /// <summary>
    /// キャプチャファイルの絶対パスを取得
    /// </summary>
    public string? GetCaptureAbsolutePath(string projectRoot)
    {
        return CaptureFile != null ? Path.Combine(projectRoot, CaptureFile) : null;
    }
}
```

**制約**:
- `CheckItemId` → CheckItems(Id) 外部キー（CASCADE DELETE）
- `DocumentId` → Documents(Id) 外部キー（CASCADE DELETE）
- 履歴として複数レコードを保持可能（削除せずに新規追加）

**履歴管理の仕組み**:
```csharp
// 例: "平面図" に資料を紐づける履歴
CheckItemDocuments テーブル:
| Id | CheckItemId | DocumentId | LinkedAt            |
|----|-------------|------------|---------------------|
| 1  | 10          | 5          | 2025-10-01 10:00:00 | ← 古い紐づけ
| 2  | 10          | 8          | 2025-10-03 14:30:00 | ← 古い紐づけ
| 3  | 10          | 12         | 2025-10-06 09:15:00 | ← 最新（LinkedAtが最大）
```

最新の紐づけは`LinkedAt`の最大値で判定します。

---

### 2.4 ItemStatus（値オブジェクト）

**責務**: チェック項目の状態を表現

```csharp
namespace DocumentFileManager.Domain.ValueObjects;

/// <summary>
/// チェック項目の状態
/// </summary>
public enum ItemStatus
{
    /// <summary>
    /// 未指定（グレー）
    /// </summary>
    Unspecified = 0,

    /// <summary>
    /// 現行（緑）
    /// </summary>
    Current = 1,

    /// <summary>
    /// 改訂（黄色）
    /// </summary>
    Revised = 2,

    /// <summary>
    /// キャンセル（赤）
    /// </summary>
    Cancelled = 3
}
```

**状態遷移**:
```
Unspecified (0) → Current (1) → Revised (2) → Cancelled (3) → Unspecified (0)
   (未指定)         (現行)         (改訂)       (キャンセル)      (ループ)
```

---

## 3. ER図

```
┌────────────────────┐
│    CheckItems      │ 自己参照（階層構造）
├────────────────────┤        │
│ Id (PK)            │◄───────┘
│ Path (UNIQUE)      │   ParentId (FK)
│ Label              │
│ Status             │
│ ParentId (FK)      │
│ DisplayOrder       │
│ CreatedAt          │
│ UpdatedAt          │
└─────────┬──────────┘
          │ 1
          │
          │ *
┌─────────▼─────────────────┐
│  CheckItemDocuments       │
├───────────────────────────┤
│ Id (PK)                   │
│ CheckItemId (FK)          │───┐
│ DocumentId (FK)           │   │
│ LinkedAt                  │   │ *
│ CaptureFile               │   │
│ CapturedAt                │   │
└───────────────────────────┘   │
                                │ 1
                       ┌────────▼─────────┐
                       │    Documents     │
                       ├──────────────────┤
                       │ Id (PK)          │
                       │ FileName         │
                       │ RelativePath (UQ)│
                       │ FileType         │
                       │ AddedAt          │
                       └──────────────────┘
```

---

## 4. 旧モデルとの対応表

### 4.1 エンティティ対応

| 旧エンティティ | 新エンティティ | 変更内容 |
|--------------|--------------|---------|
| DocumentMeta | Document | ・名前変更<br>・Guid削除<br>・FullPath → RelativePath |
| PanelNode | CheckItem | ・ItemStateと統合<br>・Guidは削除、Pathで識別<br>・Statusを内包 |
| ItemState | CheckItem | ・PanelNodeと統合<br>・DocumentGuid削除<br>・PastDatas削除 |
| DocumentData | CheckItemDocument | ・独立エンティティ化<br>・履歴管理を改善 |
| ItemStatus | ItemStatus | 変更なし |

### 4.2 プロパティ対応

#### DocumentMeta → Document

| 旧プロパティ | 新プロパティ | 変更内容 |
|------------|------------|---------|
| Guid | Id | int型の内部IDに変更 |
| FileName | FileName | 変更なし |
| FullPath | RelativePath | 絶対パス → 相対パス |
| - | FileType | 新規追加（拡張子） |
| - | AddedAt | 新規追加（登録日時） |

#### PanelNode + ItemState → CheckItem

| 旧プロパティ（PanelNode/ItemState） | 新プロパティ | 変更内容 |
|--------------------------------|------------|---------|
| PanelNode.Guid | Path | GUID → 階層パス（文字列） |
| PanelNode.Label / ItemState.Label | Label | 統合 |
| PanelNode.Children | Children | 変更なし |
| ItemState.Status | Status | CheckItemに統合 |
| ItemState.DocumentGuid | - | 削除（CheckItemDocumentで管理） |
| ItemState.CaptureFile | - | 削除（CheckItemDocumentで管理） |
| ItemState.PastDatas | LinkedDocuments | 別テーブルで管理 |

---

## 5. ドメインロジック

### 5.1 CheckItem

**階層操作**:
```csharp
// 子項目を追加
public void AddChild(CheckItem child)
{
    child.ParentId = this.Id;
    child.Path = $"{this.Path}/{child.Label}";
    Children.Add(child);
}

// 深さ優先探索で全子孫を取得
public IEnumerable<CheckItem> GetAllDescendants()
{
    foreach (var child in Children)
    {
        yield return child;
        foreach (var descendant in child.GetAllDescendants())
        {
            yield return descendant;
        }
    }
}
```

**状態管理**:
```csharp
// 状態を次に進める
item.AdvanceStatus();

// 状態をリセット
item.Status = ItemStatus.Unspecified;
item.UpdatedAt = DateTime.UtcNow;
```

### 5.2 Document

**ファイル操作**:
```csharp
// ファイルを開く
public void Open(string projectRoot)
{
    var absolutePath = GetAbsolutePath(projectRoot);
    if (Exists(projectRoot))
    {
        Process.Start(new ProcessStartInfo(absolutePath) { UseShellExecute = true });
    }
    else
    {
        throw new FileNotFoundException($"ファイルが見つかりません: {absolutePath}");
    }
}
```

### 5.3 CheckItemDocument

**紐づけ作成**:
```csharp
public static CheckItemDocument Create(CheckItem item, Document document, string? captureFile = null)
{
    return new CheckItemDocument
    {
        CheckItemId = item.Id,
        DocumentId = document.Id,
        LinkedAt = DateTime.UtcNow,
        CaptureFile = captureFile,
        CapturedAt = captureFile != null ? DateTime.UtcNow : null
    };
}
```

---

## 6. ユースケースとの対応

### UC-001: 資料を登録する
```csharp
var document = new Document
{
    FileName = "設計書_rev1.pdf",
    RelativePath = "documents/設計書_rev1.pdf",
    FileType = ".pdf",
    AddedAt = DateTime.UtcNow
};
_context.Documents.Add(document);
await _context.SaveChangesAsync();
```

### UC-011: チェック項目の状態を更新する
```csharp
var item = await _context.CheckItems.FindAsync(itemId);
item.AdvanceStatus();
await _context.SaveChangesAsync();
```

### UC-012: チェック項目に資料を紐づける
```csharp
var link = CheckItemDocument.Create(checkItem, document);
_context.CheckItemDocuments.Add(link);
await _context.SaveChangesAsync();
```

---

## 7. まとめ

### 新ドメインモデルの利点

1. ✅ **シンプル化**: PanelNodeとItemStateの二重管理を廃止
2. ✅ **人間可読**: GUIDではなく階層パスで識別
3. ✅ **ポータブル**: 相対パスでプロジェクトごと移動可能
4. ✅ **整合性保証**: 外部キー制約で自動保証
5. ✅ **履歴管理**: CheckItemDocumentsテーブルで明示的に管理

### 移行時の注意点

- 旧XMLデータ（DocumentMeta.xml, Status.xml, CheckPanelNode.xml）からの移行ツールが必要
- GUIDベースの識別から階層パスベースへの変換ロジックが必要
- 既存のViewModelやUIコードの大幅な修正が必要

---

**関連ドキュメント**:
- [データ設計書.md](./データ設計書.md) - テーブル設計とEF Coreマッピング
- [データ構造の問題点分析.md](./データ構造の問題点分析.md) - 旧設計の問題点
- [ユースケース.md](./ユースケース.md) - 機能要件
