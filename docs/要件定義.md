# 資料保存アプリ 要件定義

> **更新情報**: 2025-10-06にデータ基盤を刷新しました。
> - UI: Windows Forms → **WPF**
> - データ永続化: XML → **SQLite + Entity Framework Core**
> - ドメインモデル: 新設計（詳細は[ドメインモデル定義書.md](./ドメインモデル定義書.md)参照）

## 1. 背景と目的
- 技術資料（PDF 等）とチェックリスト項目を統合管理し、資料と作業進捗を紐づけて可視化する
- 現行バージョンを全面刷新し、保守性・拡張性・運用性を高めた新アプリケーションとして再構築する
- 既存資産の知見と課題を整理し、新規実装に反映する

## 2. システム概要
- 種別: **WPF** ベースのデスクトップアプリケーション（.NET 8）
- 永続化方式: **SQLite** データベース（`workspace.db`）によるプロジェクト単位管理
- 配置想定: 単体 PC でのスタンドアロン運用（プロジェクトフォルダごと配布可能）
- 配置想定: 単体 PC でのスタンドアロン運用（将来的なネットワーク共有を考慮）
- 主目的: 資料とチェックリストを同一 UI 上で扱い、状態管理・履歴管理・資料関連付けを容易にする

## 3. ステークホルダーと利用者
- 資料管理者: 資料登録、分類、検索を担当
- チェック作業者: チェックリストの更新、資料紐づけ、キャプチャ取得を担当
- メンテナンス担当: 設定・バージョン管理、障害対応
- 組織マネージャー: 進捗と履歴の監査、運用ルール整備

## 4. 利用環境と前提条件
- 対応 OS: Windows 10 / 11
- 実行環境: .NET 8 Runtime（WinForms）
- 入出力デバイス: マウス・キーボード操作、ドラッグ＆ドロップ
- 解像度: 1920x1080 以上を推奨
- ネットワーク: オフライン利用を前提、資料フォルダのネットワーク共有は任意

## 5. 業務フロー（概要）
1. 資料ファイルを登録し、メタデータを生成して一覧表示
2. チェックリスト構造を定義・参照し、項目状態を更新
3. チェック項目と資料を紐づけ、画面キャプチャなど補足情報を追加
4. 作業内容を保存し、次回起動時に復元して継続

## 6. 機能要件
| ID | 機能 | 概要 | 主な対応ユースケース |
|----|------|------|------------------|
| F-01 | 資料登録・一覧管理 | PDF 等の資料を登録し、一覧・フィルタ・検索できる | UC-001, UC-002, UC-004, UC-005 |
| F-02 | 資料閲覧・外部起動 | ListView から資料を開き外部アプリで閲覧できる | UC-003 |
| F-03 | チェックリスト定義 | ツリー構造のチェックリストを作成・編集できる | UC-010, UC-014 |
| F-04 | チェック状態管理 | 未指定 → 現行 → 改訂 → キャンセル の状態遷移を制御する | UC-011 |
| F-05 | 資料紐づけ | チェック項目と資料を紐づけ／解除できる | UC-012 |
| F-06 | 画面キャプチャ | 外部ウィンドウのスクリーンショットを取得し保存する | UC-013 |
| F-07 | データ保存・復元 | XML で保存し、起動時に復元する | UC-020, UC-021 |
| F-08 | 整合性検証 | 資料ファイルの存在検証と整合性チェックを実施する | UC-022 |
| F-09 | 設定管理 | フォルダパス・UI 設定を外部設定ファイルで管理する | 追加要件 |
| F-10 | ログ・エラー通知 | 例外時にログ出力・ユーザー通知を行う | 追加要件 |

## 7. 非機能要件
| 区分 | 要求水準 | 補足 |
|------|----------|------|
| 性能 | 起動 3 秒以内、資料 100 件一覧 1 秒以内、保存 3 秒以内 | ユースケース仕様の性能要件に準拠 |
| 可用性 | 保存前に `.backup` を生成して障害時の復旧を容易化 | XML 保存処理でバックアップ作成 |
| 信頼性 | GUID による一意識別、整合性検証と自動クリーンアップ | 監視サービス導入を検討 |
| 保守性 | 設定値外部化、DI 構成のモジュール化、不要コード排除 | 新アーキテクチャで担保 |
| 操作性 | マウス／キーボード／ドラッグ＆ドロップ対応、日本語 UI | ダークモード・多言語は将来拡張 |
| セキュリティ | ローカルファイルアクセスのみ、認証不要 | 機密資料向け暗号化は課題として継続検討 |
| 拡張性 | 将来の WPF / MAUI への移行やプラグイン対応を見据える | 層構造と疎結合設計を採用 |
| 運用性 | ログ出力、例外通知、導入手順ドキュメントを整備 | README と運用手順書を提供 |

## 8. データおよび外部インターフェース要件
- データ形式: XML（UTF-8）、設定値は JSON (`appsettings.json`) で管理
- 保存タイミング: 自動保存、フォームクローズ時、明示的保存
- バックアップ: 保存前に既存ファイルを `.backup` として退避
- 外部連携: OS 標準 API を用いたファイル操作・外部ビューア起動
- 画面キャプチャ: Windows API を利用した PNG/JPEG 保存

## 9. 運用・保守要件
- ドキュメント: README、アーキテクチャ資料、ユースケース仕様を UTF-8 で整備
- 設定管理: `appsettings.json` とユーザー別オーバーライド設定をサポート
- ログ保管: `./Logs` にローリング可能なテキストログを出力
- テスト: ドメイン層／サービス層のユニットテストおよび主要ユースケースの自動テスト
- デプロイ: ClickOnce / MSIX 等による配布を検討

## 10. 制約・リスク
- 現行ソリューションの依存関係が複雑で、再構築時に影響範囲が読みづらい
- ネットワーク共有が不安定な場合、資料ファイル整合性の保証が難しい
- ドキュメントの文字コード混在による情報欠損リスク
- 画面キャプチャ機能は OS 設定や権限に依存し、環境差異が大きい

## 11. 現行実装の整理
### 11.1 ソリューション構成
- `資料保存アプリ.sln` には 13 プロジェクトが含まれ、UI・ドメイン・サービス・設定・定義エディタなど多層に分散
- ユーティリティ（ScreenCaptureLib, WindowHandleLib, WindowPositionTracker）や統合パッケージ（DocumentManagerApp.Unified）が存在
- テスト／試作プロジェクトがルートに多数配置され構造が冗長

### 11.2 アーキテクチャと依存関係
- メインプロジェクトがライブラリ型 (`OutputType=Library`) のため直接実行可能な .exe が生成されない
- DI 設定 (`BootStrap.cs`) が 150 行超で複雑な依存関係を構築、ファクトリークラスが多数存在
- 設定値がコード内にハードコードされ、ネットワークパスなど環境依存が強い

### 11.3 現行機能の実装状況
- 資料登録、一覧表示、フィルタ・検索、外部起動といった資料管理系機能は実装済み
- チェックリスト定義・状態管理・資料紐づけ・画面キャプチャなどチェック作業系機能も提供
- データ保存・復元は XML を利用し、起動時の整合性検証は限定的（起動時のみ）
- ログ／例外処理は `Console.WriteLine` など最低限で、ユーザー通知が不十分

### 11.4 把握されている課題
- NuGet パッケージ構成が複雑で、ProjectReference と PackageReference が混在
- 未使用コード・コメントアウトが多く、ディレクトリにサンプルコードが散在
- ドキュメントの文字化け（Shift_JIS）により最新情報が共有されにくい
- 依存関係グラフが複雑で循環参照リスクを内包、リファクタリングが困難

### 11.5 新規実装への活用ポイント
- 豊富な実装資産を参照し、ユースケースやドメインモデルの理解を深める
- 現行の課題を改善項目として取り込み、設計初期からシンプルな構成を採用
- 既存 XML スキーマや UI 振る舞いを検証し、移行時のデータ互換性を計画