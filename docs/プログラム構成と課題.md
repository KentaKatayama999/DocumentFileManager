# 資料保存アプリ - プログラム構成と課題分析

**最終更新日**: 2025-10-04

---

## 目次

1. [システム概要](#システム概要)
2. [プロジェクト構成](#プロジェクト構成)
3. [アーキテクチャ](#アーキテクチャ)
4. [主要なドメインモデル](#主要なドメインモデル)
5. [技術スタック](#技術スタック)
6. [問題点と課題](#問題点と課題)
7. [改善提案](#改善提案)

---

## システム概要

### アプリケーション名
**資料保存アプリ (Document Manager Application)**

### 目的
技術資料（PDFファイルなど）とチェックリストアイテムを統合管理し、資料とチェック項目を紐づけて作業進捗を管理するWindows Formsデスクトップアプリケーション

### 主要機能
1. **ドキュメント管理**: 資料ファイルの登録、一覧表示、フィルタリング
2. **チェックリスト管理**: ツリー構造のチェックリスト、状態管理（未指定/現行/改訂/キャンセル）
3. **紐づけ機能**: チェック項目と資料ファイルの関連付け
4. **画面キャプチャ**: 外部ウィンドウのスクリーンキャプチャ取得
5. **データ永続化**: XMLファイルによる状態の保存と復元

---

## プロジェクト構成

### ソリューション内のプロジェクト一覧

現在のソリューション（`資料保存アプリ.sln`）には**13個のプロジェクト**が含まれています：

#### 1. メインプロジェクト
| プロジェクト名 | 種類 | 説明 | NuGetパッケージ |
|--------------|------|------|----------------|
| **資料保存アプリ** | Library | メインUIライブラリ（ReferForm, RegisterForm含む） | DocumentManagerApp.UI v1.0.18 |
| **資料保存アプリ.Domain** | Library | ドメインモデル（Entities, ValueObjects, Interfaces） | DocumentManagerApp.Core v1.0.0 |
| **資料保存アプリ.Service** | Library | サービス層（DTOs, Repositories, Factories） | DocumentManagerApp.Service v1.0.0 |
| **資料保存アプリ.Configuration** | Library | アプリケーション設定管理 | DocumentManagerApp.Configuration |
| **資料保存アプリ.DefinitionEditor** | Library | チェックリスト定義エディタ | - |

#### 2. ユーティリティライブラリ
| プロジェクト名 | 説明 | NuGetパッケージ |
|--------------|------|----------------|
| **ScreenCaptureLib** | スクリーンキャプチャ機能 | - |
| **WindowHandleLib** | ウィンドウハンドル管理 | DocumentManagerApp.WindowHandle v1.0.16 |
| **WindowPositionTracker** | ウィンドウ位置追跡 | - |

#### 3. 統合パッケージ
| プロジェクト名 | 種類 | 説明 | NuGetパッケージ |
|--------------|------|------|----------------|
| **DocumentManagerApp.Unified** | メタパッケージ | 全機能を含む統合パッケージ | DocumentManagerApp.Complete v2.0.9 |

#### 4. テスト/試作プロジェクト
- 資料保存アプリテスト
- UIコントロールテスト
- TestDocumentManagerApp
- TestDefinitionEditor
- NuGetTest
- PdfViewer（外部参照）

### ディレクトリ構造

```
資料保存アプリ/
├── docs/                          # ドキュメント
├── 資料保存アプリ/                 # メインUIプロジェクト
│   ├── BootStrap.cs               # アプリケーション起動・DI設定
│   ├── Program.cs                 # エントリーポイント
│   ├── DiContainer/               # DIコンテナ設定
│   ├── Factories/                 # ファクトリークラス
│   ├── Presentation/              # プレゼンテーション層
│   ├── ViewModels/                # MVVM ViewModels
│   └── Views/                     # フォームとUIコントロール
│       ├── Forms/
│       │   ├── ReferForm/         # 参照フォーム（資料一覧）
│       │   └── RegisterForm/      # 登録フォーム（チェックリスト）
│       └── FileHandling/          # ファイル操作
├── 資料保存アプリ.Domain/          # ドメイン層
│   ├── Domain/
│   │   ├── Entities/              # エンティティ（DocumentMeta, ItemState, PanelNode）
│   │   ├── Collections/           # コレクション
│   │   └── ValueObjects/          # 値オブジェクト（ItemStatus, CheckPanelMode）
│   └── Interfaces/                # リポジトリインターフェース
├── 資料保存アプリ.Service/         # サービス層
│   ├── DTOs/                      # データ転送オブジェクト
│   ├── Repositories/              # リポジトリ実装（XML永続化）
│   └── Factorys/                  # ファクトリ実装
├── 資料保存アプリ.Configuration/   # 設定管理
├── 資料保存アプリ.DefinitionEditor/ # 定義エディタ
├── ScreenCaptureLib/              # キャプチャライブラリ
├── WindowHandleLib/               # ウィンドウ管理ライブラリ
├── WindowPositionTracker/         # 位置追跡ライブラリ
└── DocumentManagerApp.Unified/    # 統合パッケージ
```

---

## アーキテクチャ

### レイヤー構成

```
┌─────────────────────────────────────────┐
│     Presentation Layer (UI)             │
│  - ReferForm (資料一覧・参照)            │
│  - RegisterForm (チェックリスト・登録)   │
│  - ViewModels (MVVM)                    │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│     Service Layer                       │
│  - DTOs (ReferFormDto, RegisterFormDto) │
│  - Repositories (XML永続化)             │
│  - Factories                            │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│     Domain Layer (Core)                 │
│  - Entities (DocumentMeta, ItemState)   │
│  - ValueObjects (ItemStatus)            │
│  - Interfaces                           │
└─────────────────────────────────────────┘
```

### 主要な設計パターン

1. **Repository パターン**
   - `IDocumentMetaRepository`
   - `IItemStateRepository`
   - `ICheckPanelNodeRepository`

2. **Factory パターン**
   - `ReferFormDtoFactory`
   - `RegisterFormDtoFactory`
   - `CheckListPanelFactory`

3. **MVVM パターン**
   - `ReferFormVM`
   - `ListViewVM`

4. **Dependency Injection**
   - Microsoft.Extensions.DependencyInjection
   - `BootStrap.cs`でDIコンテナ設定

5. **Event-Driven**
   - `DocumentEventBinder`（資料選択イベントの伝播）

---

## 主要なドメインモデル（新設計）

> **注**: 2025-10-06にSQLite + Entity Framework Coreを採用し、ドメインモデルを刷新しました。
> 詳細は[ドメインモデル定義書.md](./ドメインモデル定義書.md)を参照してください。

### 1. CheckItem（チェックリスト項目）

```csharp
public class CheckItem
{
    public int Id { get; set; }                    // 内部ID
    public string Path { get; set; }               // 階層パス（例: "設計図面/平面図"）
    public string Label { get; set; }              // 表示名
    public ItemStatus Status { get; set; }         // 状態
    public int? ParentId { get; set; }             // 親項目ID
    public CheckItem? Parent { get; set; }         // 親項目
    public List<CheckItem> Children { get; set; }  // 子項目
    public int DisplayOrder { get; set; }          // 表示順序
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public List<CheckItemDocument> LinkedDocuments { get; set; } // 紐づけリスト
}
```

**責務**: チェックリストの項目と状態を統合管理（旧PanelNode + ItemStateを統合）

**永続化**: SQLite `CheckItems`テーブル

**主な変更点**:
- GUIDを廃止し、階層パス（文字列）で識別
- PanelNodeとItemStateを統合し、二重管理を廃止
- 相対パスで可搬性を確保

---

### 2. Document（資料）

```csharp
public class Document
{
    public int Id { get; set; }                    // 内部ID
    public string FileName { get; set; }           // ファイル名
    public string RelativePath { get; set; }       // 相対パス
    public string FileType { get; set; }           // ファイル種別（拡張子）
    public DateTime AddedAt { get; set; }          // 登録日時
    public List<CheckItemDocument> LinkedCheckItems { get; set; } // 紐づけリスト
}
```

**責務**: 資料ファイルのメタデータを管理（旧DocumentMeta）

**永続化**: SQLite `Documents`テーブル

**主な変更点**:
- クラス名をDocumentMetaからDocumentに簡潔化
- GUIDを廃止
- 絶対パス（FullPath）から相対パス（RelativePath）に変更

---

### 3. CheckItemDocument（紐づけ）

```csharp
public class CheckItemDocument
{
    public int Id { get; set; }
    public int CheckItemId { get; set; }
    public CheckItem CheckItem { get; set; }
    public int DocumentId { get; set; }
    public Document Document { get; set; }
    public DateTime LinkedAt { get; set; }         // 紐づけ日時
    public string? CaptureFile { get; set; }       // キャプチャパス
    public DateTime? CapturedAt { get; set; }      // キャプチャ日時
}
```

**責務**: チェック項目と資料の関連付けを管理（履歴対応）

**永続化**: SQLite `CheckItemDocuments`テーブル

**主な変更点**:
- ItemState内のDocumentGuidを独立エンティティ化
- 履歴管理を明示的に実装（PastDatasの代替）

---

### 4. ItemStatus（値オブジェクト）

```csharp
public enum ItemStatus
{
    Unspecified = 0,  // 未指定（グレー）
    Current = 1,      // 現行（緑）
    Revised = 2,      // 改訂（黄）
    Cancelled = 3     // キャンセル（赤）
}
```

**変更**: なし（旧設計と同じ）

---

## 技術スタック

### フレームワーク
- **.NET 8.0** (`net8.0-windows`)
- **Windows Forms** (デスクトップUI)

### NuGetパッケージ（新設計）
| パッケージ名 | バージョン | 用途 |
|------------|-----------|------|
| Microsoft.EntityFrameworkCore.Sqlite | 8.0.0 | SQLiteデータアクセス |
| Microsoft.EntityFrameworkCore.Design | 8.0.0 | マイグレーションツール |
| CommunityToolkit.Mvvm | 8.4.0 | MVVMパターン実装 |
| Microsoft.Extensions.Configuration | 9.0.6 | 設定管理 |
| Microsoft.Extensions.DependencyInjection | 9.0.6 | DIコンテナ |

### データ永続化（新設計）
- **SQLite 3** + **Entity Framework Core 8.0**
  - `workspace.db`: プロジェクト単位のデータベースファイル
  - テーブル: CheckItems, Documents, CheckItemDocuments
  - トランザクション保証、外部キー制約で整合性を自動保証

> **旧設計**: XMLファイル3つ（DocumentMeta.xml, Status.xml, CheckPanelNode.xml）
> → 新設計で統合・簡素化

---

## 問題点と課題

### 1. アーキテクチャ上の問題

#### 1.1 複雑なNuGetパッケージ構成
**現状**:
- 個別パッケージ（Core, Service, UI）と統合パッケージ（Complete）が混在
- バージョン管理が不統一（v1.0.0 ～ v2.0.9）
- "ハイブリッド方式"によるProjectReferenceとPackageReferenceの混在

**問題点**:
- パッケージ間の依存関係が複雑
- バージョン更新時の整合性維持が困難
- NuGet公開を前提とした設計だが、実際にはローカル参照が多用

**影響**:
- メンテナンス性の低下
- ビルド時間の増加
- 依存関係の把握が困難

---

#### 1.2 プロジェクトタイプの不一致
**現状**:
```xml
<PropertyGroup>
  <OutputType>Library</OutputType>  <!-- ライブラリ型 -->
  <TargetFramework>net8.0-windows</TargetFramework>
</PropertyGroup>
```

- メインプロジェクト（`資料保存アプリ`）がLibrary型
- しかし`Program.cs`にエントリーポイント（`Main()`）が存在

**問題点**:
- 実行可能ファイル（.exe）ではなくDLL（.dll）が生成される
- 直接実行できない
- NuGetライブラリとデスクトップアプリの責務が混在

**影響**:
- 配布が困難
- ユーザーが混乱

---

#### 1.3 ハードコードされた設定
**現状** (`Program.cs:22-26`):
```csharp
var DocumentPath = "../../../../TestData/Document";
var DefinitionPath = "//desnas03/CFD/k_katayama/DefFiles";
DefinitionPath = "//desnas03/ProjectFolders/DefFiles";
var localPath = @"C:\Users\ken-katayama\Desktop\フォルダ管理ツールテスト\フォルダ管理ローカル";
localPath = "";
```

**問題点**:
- 環境固有のパスがハードコード
- ネットワークパス（`//desnas03/...`）への依存
- 他の環境では動作しない
- コメントアウトされた設定が残存

**影響**:
- ポータビリティがない
- 他のユーザーや環境で利用不可
- テストが困難

---

#### 1.4 複雑な依存関係
**現状**:
- 多数のファクトリークラス（`ReferFormDtoFactory`, `RegisterFormFactory`, `CheckListPanelFactory`など）
- 深いDI階層（`BootStrap.cs`で150行以上のDI設定）
- サービス間の複雑な依存

**問題点**:
- コンストラクタの引数が多い（8個以上のケースあり）
- 依存関係グラフが複雑
- 循環参照のリスク

**影響**:
- コードの理解が困難
- テストの作成が難しい
- リファクタリングのリスクが高い

---

### 2. コード品質の問題

#### 2.1 文字エンコーディングの問題
**現状**:
- `機能一覧.md`、`クラス構成図.md`などのドキュメントが文字化け
- 原因: Shift_JIS エンコーディング

**問題点**:
- ドキュメントが読めない
- Git管理で問題が発生する可能性

**影響**:
- ドキュメントの保守不可
- チーム開発での共有が困難

---

#### 2.2 未使用コードの残存
**現状**:
- コメントアウトされたコード（`Program.cs`など）
- 未使用のテストプロジェクト多数
- 試行錯誤の痕跡が残存

**問題点**:
- コードが肥大化
- 実際の動作が不明確
- メンテナンス性の低下

**影響**:
- 開発効率の低下
- バグの温床

---

#### 2.3 ファイル構成の問題
**現状**:
```
資料保存アプリ/
├── CompletePackageTest_Program.cs
├── DefinitionEditor_Usage_Example.cs
├── MyDocumentProject_Example_Program.cs
├── PackageInfo_Alternative.cs
├── TestProject_Example_Program.cs
├── NuGetConsoleTest/
├── NuGetTest/
├── PdfViewerTest/
├── TestDefinitionEditor/
├── TestDocumentManagerApp/
└── 資料保存アプリテスト/
```

**問題点**:
- ルートディレクトリにサンプルコードが散乱
- テスト/試作プロジェクトが整理されていない
- 本番コードとテストコードの区別が不明確

**影響**:
- プロジェクト構造が分かりにくい
- ビルド時間の増加

---

### 3. 機能的な問題

#### 3.1 データ検証の不足
**現状**:
- 資料ファイルの存在チェックは起動時のみ（`ValidateDocumentsInItemStates()`）
- ファイル移動・削除時のリアルタイム検証なし

**問題点**:
- 資料ファイルが移動・削除されても気づけない
- データの整合性が保証されない

**影響**:
- ユーザーエクスペリエンスの低下
- データ破損のリスク

---

#### 3.2 エラーハンドリングの不足
**現状**:
- 一部の例外処理が`Console.WriteLine()`のみ
- ユーザーへのフィードバックが不十分

**問題点**:
- エラーが発生してもユーザーに伝わらない
- デバッグが困難

**影響**:
- ユーザビリティの低下
- サポートコストの増加

---

### 4. ドキュメントの問題

#### 4.1 ドキュメント不足
**現状**:
- README.mdが簡素
- セットアップ手順が不明
- アーキテクチャドキュメントが古い（文字化け）

**問題点**:
- 新規参加者が理解できない
- メンテナンスが困難

**影響**:
- 属人化
- 引き継ぎが困難

---

## 改善提案

### フェーズ1: 即座に改善可能な項目

#### 1. ドキュメントの整備
- [ ] エンコーディングをUTF-8に統一
- [ ] README.mdの充実（セットアップ手順、使い方）
- [ ] アーキテクチャドキュメントの更新（このドキュメント）

#### 2. 設定の外部化
- [ ] `appsettings.json`の導入
- [ ] パスのハードコードを除去
- [ ] 環境変数またはユーザー設定ファイルの利用

#### 3. 不要コードの削除
- [ ] コメントアウトされたコードの削除
- [ ] 未使用のテストプロジェクトの削除またはarchiveフォルダへ移動
- [ ] ルートディレクトリのサンプルコードの整理

---

### フェーズ2: アーキテクチャの簡素化（再構築を検討）

#### 1. シンプルな実行可能アプリケーション化

**提案**:
```xml
<PropertyGroup>
  <OutputType>WinExe</OutputType>  <!-- 実行可能ファイル -->
  <TargetFramework>net8.0-windows</TargetFramework>
</PropertyGroup>
```

**効果**:
- 直接実行可能な.exeファイルが生成される
- 配布が容易
- NuGetパッケージ化は後回し

---

#### 2. プロジェクト構成の見直し

**現状**: 13プロジェクト

**提案**: 最小構成（3～4プロジェクト）
```
資料保存アプリ.sln
├── DocumentManager.App (WinExe)           # UIとエントリーポイント
├── DocumentManager.Core (Library)         # ドメイン層
├── DocumentManager.Infrastructure (Library) # データアクセス層
└── DocumentManager.Tests (Test)           # テストプロジェクト
```

**効果**:
- 依存関係がシンプル
- ビルド時間の短縮
- 理解しやすい

---

#### 3. DIの簡素化

**現状**: `BootStrap.cs`が150行以上

**提案**:
- サービス登録を機能ごとに分割（拡張メソッド）
- 不要なファクトリークラスを統合
- コンストラクタの引数を削減（最大5個まで）

```csharp
services.AddDomainServices();
services.AddInfrastructure();
services.AddPresentationServices();
```

**効果**:
- 見通しが良くなる
- テストが容易

---

#### 4. 設定管理の改善

**提案**:
```json
// appsettings.json
{
  "Paths": {
    "DocumentFolder": "./Documents",
    "DefinitionFolder": "./Definitions",
    "CaptureFolder": "./Captures"
  },
  "UI": {
    "Theme": "Light",
    "Language": "ja-JP"
  }
}
```

**効果**:
- 環境ごとの設定変更が容易
- ハードコードの除去

---

### フェーズ3: 機能拡張

#### 1. データ検証の強化
- [ ] ファイル監視機能（FileSystemWatcher）
- [ ] 定期的な整合性チェック
- [ ] 自動修復機能

#### 2. エラーハンドリングの改善
- [ ] グローバル例外ハンドラ
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] ログ機能（Serilog, NLogなど）

#### 3. UI/UXの改善
- [ ] モダンなUIデザイン（WPFまたはMAUI検討）
- [ ] ダークモード対応
- [ ] 多言語対応

---

## まとめ

### 現状の強み
- ✅ ドメインモデルがしっかり設計されている
- ✅ 基本機能は実装済み
- ✅ 3層アーキテクチャが採用されている

### 主要な課題
- ⚠️ NuGetパッケージ構成が複雑
- ⚠️ 設定がハードコード
- ⚠️ 実行可能ファイルではない
- ⚠️ ドキュメントが不足

### 推奨アクション
1. **短期**: ドキュメント整備、設定外部化、不要コード削除
2. **中期**: プロジェクト構成の簡素化、WinExe化
3. **長期**: モダンなUIフレームワークへの移行検討

---

**次のステップ**: [ユースケース.md](./ユースケース.md)を参照して、各機能の詳細な仕様を確認してください。
