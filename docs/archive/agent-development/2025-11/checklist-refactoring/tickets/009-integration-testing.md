# チケット #009: 統合テストとリグレッションテスト

## 基本情報

- **ステータス**: Done
- **優先度**: High
- **見積もり**: 4時間
- **作成日**: 2025-11-28
- **更新日**: 2025-11-28
- **依存チケット**: #008
- **タグ**: testing, integration, regression

## 概要

リファクタリング後の動作を手動テストで確認し、既存機能が壊れていないこと、async/await競合が解消されていることを検証します。BDDシナリオに基づいた網羅的なテストを実施します。

## 実装内容

### 1. 手動テストシナリオ

#### シナリオ 1: チェックON → キャプチャ取得 → 正常保存

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が未チェック状態（状態: 00）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: キャプチャ確認ダイアログで「はい」を選択
**And**: 範囲選択してキャプチャを保存

**Then**: チェックボックスがON状態になる
**And**: カメラボタン（📷）が表示される
**And**: DBにCheckItemDocumentレコードが作成される（IsChecked=true, CaptureFile設定）
**And**: 状態が11（チェックON、キャプチャあり）になる

**検証手順**:
1. ChecklistWindowを開く
2. 未チェックの項目を探す
3. チェックボックスをクリック
4. ダイアログで「はい」を選択
5. キャプチャ範囲を選択
6. チェックボックスがONになることを確認
7. カメラボタンが表示されることを確認
8. DBを確認（SQLiteツールまたはログ）
9. 状態コードが11であることを確認

#### シナリオ 2: チェックON → キャプチャなし

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が未チェック状態（状態: 00）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: キャプチャ確認ダイアログで「いいえ」を選択

**Then**: チェックボックスがON状態になる
**And**: カメラボタン（📷）は表示されない
**And**: DBにCheckItemDocumentレコードが作成される（IsChecked=true, CaptureFile=null）
**And**: 状態が10（チェックON、キャプチャなし）になる

**検証手順**:
1. ChecklistWindowを開く
2. 未チェックの項目を探す
3. チェックボックスをクリック
4. ダイアログで「いいえ」を選択
5. チェックボックスがONになることを確認
6. カメラボタンが表示されないことを確認
7. DBを確認
8. 状態コードが10であることを確認

#### シナリオ 3: 既存キャプチャの復帰

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が以前キャプチャされている（状態: 22、CaptureFile設定済み）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: 復帰確認ダイアログで「はい」を選択

**Then**: チェックボックスがON状態になる
**And**: カメラボタン（📷）が表示される
**And**: DBのCheckItemDocumentレコードが更新される（IsChecked=true、CaptureFileは維持）
**And**: 状態が11（チェックON、キャプチャあり）になる

**検証手順**:
1. 事前準備: シナリオ1を実行してキャプチャを保存
2. チェックボックスをOFFにする
3. チェックボックスを再度ONにする
4. 復帰確認ダイアログで「はい」を選択
5. カメラボタンが表示されることを確認
6. DBを確認
7. CaptureFilePathが維持されていることを確認

#### シナリオ 4: チェックOFF → キャプチャ維持

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」がチェック済みでキャプチャあり（状態: 11）

**When**: ユーザーが「書類確認」のチェックボックスをOFFにする

**Then**: チェックボックスがOFF状態になる
**And**: カメラボタン（📷）が非表示になる
**And**: DBのCheckItemDocumentレコードが更新される（IsChecked=false、CaptureFileは維持）
**And**: 状態が22（チェックOFF、キャプチャあり）になる

**検証手順**:
1. シナリオ1を実行してチェックON、キャプチャありの状態にする
2. チェックボックスをOFFにする
3. カメラボタンが非表示になることを確認
4. DBを確認
5. CaptureFilePathが維持されていることを確認

#### シナリオ 5: MainWindowでチェックボックス無効化

**Given**: ユーザーがMainWindow（全体表示）を開いている

**When**: チェック項目「書類確認」を表示

**Then**: チェックボックスが無効化されている（クリック不可）
**And**: 最新のキャプチャがあれば、カメラボタン（📷）が表示される

**When**: ユーザーがチェックボックスをクリックしようとする

**Then**: チェック状態が変わらない

**検証手順**:
1. MainWindowを開く
2. チェック項目を展開
3. チェックボックスが無効化（グレーアウト）されていることを確認
4. クリックしても反応しないことを確認
5. キャプチャがある項目のカメラボタンが表示されることを確認

#### シナリオ 6: カメラボタンクリックで画像表示

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」にキャプチャがある（状態: 11）

**When**: ユーザーがカメラボタン（📷）をクリック

**Then**: CaptureImageViewerWindowが開く
**And**: 保存済みのキャプチャ画像が表示される

**When**: ビューワーで「削除」ボタンをクリック

**Then**: 画像ファイルが削除される
**And**: カメラボタン（📷）が非表示になる
**And**: DBのCaptureFileがnullに更新される

**検証手順**:
1. シナリオ1を実行してキャプチャを保存
2. カメラボタンをクリック
3. CaptureImageViewerWindowが開くことを確認
4. 画像が表示されることを確認
5. 削除ボタンをクリック
6. カメラボタンが非表示になることを確認
7. DBを確認

#### シナリオ 7: async/await競合の解消

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が未チェック状態（状態: 00）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: キャプチャ確認ダイアログで「はい」を選択
**And**: 範囲選択してキャプチャを保存

**Then**: チェックボックスの表示が即座にON状態になる（描画の遅延がない）
**And**: カメラボタン（📷）が即座に表示される（描画の遅延がない）
**And**: 非同期DB保存が完了するまで、UIがフリーズしない

**検証手順**:
1. シナリオ1を実行
2. チェックボックスのON表示が即座に反映されることを確認（1秒以内）
3. カメラボタンの表示が即座に反映されることを確認（1秒以内）
4. DB保存中にUIが操作可能であることを確認（フリーズしない）

#### シナリオ 8: 既存キャプチャの破棄

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が以前キャプチャされている（状態: 22、CaptureFile設定済み）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: 復帰確認ダイアログで「いいえ」を選択

**Then**: チェックボックスがON状態になる
**And**: カメラボタン（📷）は表示されない
**And**: DBのCaptureFileがnullに更新される
**And**: 状態が10（チェックON、キャプチャなし）になる

**検証手順**:
1. シナリオ3の準備を行う
2. チェックボックスをONにする
3. 復帰確認ダイアログで「いいえ」を選択
4. カメラボタンが表示されないことを確認
5. DBを確認
6. CaptureFilePathがnullになっていることを確認

#### シナリオ 9: 既存キャプチャ復帰のキャンセル

**Given**: ユーザーがChecklistWindowを開いている
**And**: チェック項目「書類確認」が以前キャプチャされている（状態: 22、CaptureFile設定済み）

**When**: ユーザーが「書類確認」のチェックボックスをONにする
**And**: 復帰確認ダイアログで「キャンセル」を選択

**Then**: チェックボックスがOFF状態に戻る（ロールバック）
**And**: カメラボタン（📷）は表示されない
**And**: DBは変更されない
**And**: 状態が22（チェックOFF、キャプチャあり）のまま維持される

**検証手順**:
1. シナリオ3の準備を行う
2. チェックボックスをONにする
3. 復帰確認ダイアログで「キャンセル」を選択
4. チェックボックスがOFF状態に戻ることを確認
5. DBを確認
6. レコードが変更されていないことを確認

### 2. DB確認用SQL

```sql
-- CheckItemDocumentテーブルの確認
SELECT
    cd.Id,
    ci.Label AS CheckItemLabel,
    d.Title AS DocumentTitle,
    cd.IsChecked,
    cd.CaptureFilePath,
    cd.CheckedAt
FROM CheckItemDocuments cd
INNER JOIN CheckItems ci ON cd.CheckItemId = ci.Id
INNER JOIN Documents d ON cd.DocumentId = d.Id
ORDER BY cd.CheckedAt DESC;

-- 状態コード計算（参考）
-- 状態00: レコードなし
-- 状態10: IsChecked=true, CaptureFilePath=null
-- 状態11: IsChecked=true, CaptureFilePath設定
-- 状態20: IsChecked=false, CaptureFilePath=null
-- 状態22: IsChecked=false, CaptureFilePath設定
```

### 3. 統合テスト作成（オプション）

**ファイル**: `src/DocumentFileManager.UI.Tests/Integration/ChecklistIntegrationTests.cs`

**テストケース**:
- DBと連携した状態遷移テスト
- ViewModel→DB→ViewModelの往復テスト

**注意**: WPF UIの自動テストは困難なため、優先度は低く設定します。

## 完了条件（チェックリスト）

- [ ] シナリオ1（チェックON → キャプチャ取得 → 正常保存）がパスする
- [ ] シナリオ2（チェックON → キャプチャなし）がパスする
- [ ] シナリオ3（既存キャプチャの復帰）がパスする
- [ ] シナリオ4（チェックOFF → キャプチャ維持）がパスする
- [ ] シナリオ5（MainWindowでチェックボックス無効化）がパスする
- [ ] シナリオ6（カメラボタンクリックで画像表示）がパスする
- [ ] シナリオ7（async/await競合の解消）がパスする
- [ ] シナリオ8（既存キャプチャの破棄）がパスする
- [ ] シナリオ9（既存キャプチャ復帰のキャンセル）がパスする
- [ ] すべてのシナリオでDBの状態が正しいことを確認
- [ ] UIの描画が即座に反映されることを確認（1秒以内）
- [ ] UIがフリーズしないことを確認
- [ ] 既存機能が壊れていないことを確認（リグレッションテスト）

## 技術メモ

### テスト実施のベストプラクティス

1. **クリーンな環境**: 各シナリオ前にDBをリセット
2. **ログ確認**: すべての操作でログを確認
3. **スクリーンショット**: テスト結果をスクリーンショットで記録
4. **複数回実行**: 各シナリオを3回実行して安定性を確認

### DB確認ツール

- **DB Browser for SQLite**: https://sqlitebrowser.org/
- **Visual Studio SQLite/SQL Server Compact Toolbox**: 拡張機能

### ログレベル設定

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "DocumentFileManager.UI.Services": "Debug",
      "DocumentFileManager.UI.ViewModels": "Debug"
    }
  }
}
```

## 関連ドキュメント

- `docs/behaviors/checklist-refactoring/plan.md` - Phase 7、BDDシナリオ
- `src/DocumentFileManager.UI/` - テスト対象
